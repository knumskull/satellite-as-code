---
- name: 'Install Red Hat Satellite Capsule'
  hosts: 'all'
  gather_facts: true
  become: true
  roles:
    - name: 'redhat.satellite_operations.installer'

  pre_tasks:
    - name: 'Validate Capsule installer scenario'
      ansible.builtin.assert:
        that:
          - satellite_installer_scenario == 'capsule'
        fail_msg: >
          Capsule installation requires satellite_installer_scenario set to
          'capsule'.

    - name: 'Handle certificate deployment'
      become: true
      when: >
        sat_deploy_certificates is defined
        and sat_deploy_certificates
      block:

        - name: 'Ensure certificate destination directory is present: {{ sat_cert_dest_path }}'
          ansible.builtin.file:
            path: '{{ sat_cert_dest_path }}'
            state: 'directory'
            owner: '{{ sat_cert_dest_path_owner }}'
            group: '{{ sat_cert_dest_path_group }}'
            mode: '{{ sat_cert_dest_path_mode }}'

        - name: 'Deploy Certificates to the Capsule'
          ansible.builtin.copy:
            src: '{{ _t_cert }}'
            dest: '{{ sat_cert_dest_path }}/{{ _t_cert | basename }}'
            owner: '{{ sat_certs_owner }}'
            group: '{{ sat_certs_group }}'
            mode: '{{ sat_certs_mode }}'
          loop: '{{ sat_certs }}'
          loop_control:
            loop_var: '_t_cert'

    - name: 'Generate Capsule certificate archive on Satellite'
      when: >
        capsule_satellite_server is defined
        and capsule_satellite_server | length > 0
      block:

        - name: 'Remove existing certificate archive on Satellite (regenerate)'
          ansible.builtin.file:
            path: '{{ capsule_certs_tar_remote_path }}'
            state: 'absent'
          delegate_to: '{{ capsule_satellite_server }}'
          when: >
            capsule_certs_regenerate is defined
            and capsule_certs_regenerate

        - name: 'Run capsule-certs-generate on {{ capsule_satellite_server }}'
          ansible.builtin.command:
            cmd: >-
              capsule-certs-generate
              --foreman-proxy-fqdn {{ inventory_hostname }}
              --certs-tar {{ capsule_certs_tar_remote_path }}
            creates: '{{ capsule_certs_tar_remote_path }}'
          delegate_to: '{{ capsule_satellite_server }}'

        - name: 'Fetch certificate archive from {{ capsule_satellite_server }}'
          ansible.builtin.fetch:
            src: '{{ capsule_certs_tar_remote_path }}'
            dest: '/tmp/{{ inventory_hostname }}-certs.tar'
            flat: true
          delegate_to: '{{ capsule_satellite_server }}'

        - name: 'Set certificate archive path'
          ansible.builtin.set_fact:
            satellite_installer_certs_tar_file: '/tmp/{{ inventory_hostname }}-certs.tar'

    - name: 'Validate certificate archive is available'
      ansible.builtin.assert:
        that:
          - satellite_installer_certs_tar_file is defined
          - satellite_installer_certs_tar_file | length > 0
        fail_msg: >
          No certificate archive available. Either define capsule_satellite_server
          to auto-generate it, or set satellite_installer_certs_tar_file to the
          path of a pre-generated certificate archive.

    - name: 'Deploy Capsule certificate archive'
      ansible.builtin.copy:
        src: '{{ satellite_installer_certs_tar_file }}'
        dest: '/root/{{ satellite_installer_certs_tar_file | basename }}'
        owner: 'root'
        group: 'root'
        mode: '0600'

    - name: 'Update certs-tar-file in installer options'
      ansible.builtin.set_fact:
        satellite_installer_options: >-
          {{ satellite_installer_options +
             ['--certs-tar-file /root/' + (satellite_installer_certs_tar_file | basename)] }}

    - name: 'Handle firewalld configuration'
      become: true
      block:

        - name: 'Configure firewalld ports'
          ansible.posix.firewalld:
            zone: "{{ _t_port.zone | default('public') }}"
            port: '{{ _t_port.port }}'
            state: 'enabled'
            permanent: true
            immediate: true
          loop: '{{ sat_firewall_ports }}'
          loop_control:
            loop_var: '_t_port'

        - name: 'Configure firewalld services'
          ansible.posix.firewalld:
            zone: "{{ _t_service.zone | default('public') }}"
            service: '{{ _t_service.name }}'
            state: 'enabled'
            permanent: true
            immediate: true
          loop: '{{ sat_firewall_services }}'
          loop_control:
            loop_var: '_t_service'

    - name: 'Verify {{ sat_package_name }} is installed'
      ansible.builtin.dnf:
        name: '{{ sat_package_name }}'
        state: 'present'
