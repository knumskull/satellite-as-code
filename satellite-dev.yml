---
- name: Install Satellite dependencies
  hosts: satellite-dev
  gather_facts: true
  become: true

  vars_files:
    - config/crazy_lab.vault

  vars:
    satellite_version: 6.17

  tasks:
    - name: Register with activationkey
      community.general.redhat_subscription:
        state: present
        activationkey: "{{ sfroemer_redhat_activationkey }}"
        org_id: "{{ sfroemer_redhat_organization_id }}"

    - name: Disable all repositories except the one required for Satellite
      community.general.rhsm_repository:
        name:
          - rhel-9-for-x86_64-baseos-rpms
          - rhel-9-for-x86_64-appstream-rpms
          - "satellite-{{ satellite_version }}-for-rhel-9-x86_64-rpms"
          - "satellite-maintenance-{{ satellite_version }}-for-rhel-9-x86_64-rpms"
        purge: true

    - name: Install fapolicyd
      ansible.builtin.package:
        name: fapolicyd
        state: present


    - name: Enable Service fapolicyd
      ansible.builtin.service:
        name: fapolicyd
        state: started
        enabled: true


- name: Install Satellite Software
  hosts: satellite-dev
  gather_facts: true
  become: true

  vars_files:
    - config/crazy_lab.vault
    - config/accounts.vault

  tasks:

    - name: 'Handle firewalld configuration'
      become: true
      block:

        - name: 'Configure firewalld ports'
          ansible.posix.firewalld:
            zone: "{{ _t_port.zone | default('public') }}"
            port: '{{ _t_port.port }}'
            state: 'enabled'
            permanent: true
            immediate: true
          loop: '{{ sat_firewall_ports }}'
          loop_control:
            loop_var: '_t_port'

        - name: 'Configure firewalld services'
          ansible.posix.firewalld:
            zone: "{{ _t_service.zone | default('public') }}"
            service: '{{ _t_service.name }}'
            state: 'enabled'
            permanent: true
            immediate: true
          loop: '{{ sat_firewall_services }}'
          loop_control:
            loop_var: '_t_service'

    - name: Run satellite-installer
      ansible.builtin.import_role:
        name: redhat.satellite_operations.installer
      vars:
        satellite_installer_scenario: satellite
        satellite_installer_options:
          - '--foreman-initial-organization {{ satellite_organization }}'
          - '--foreman-initial-admin-password {{ satellite_password }}'
          - '--foreman-initial-location {{ satellite_initial_location }}'

    - name: Download and install Satellite Manifest
      ansible.builtin.import_role:
        name: redhat.satellite.manifest
      vars:
        satellite_manifest_path: "/tmp/manifest.zip"
        satellite_manifest_download: true
        satellite_rhsm_username: "{{ REDHAT_RHSM_USERNAME }}"
        satellite_rhsm_password: "{{ REDHAT_RHSM_PASSWORD }}"
        satellite_manifest_uuid: "{{ crazy_lab_satellite_manifest_uuid }}"

    - name: Setup Satellite Lifecyle Environments
      ansible.builtin.import_role:
        name: redhat.satellite.lifecycle_environments


    - name: Configure Red Hat Repositories
      ansible.builtin.import_role:
        name: redhat.satellite.repositories

    - name: Synchronize configured Repositories
      redhat.satellite.repository_sync:
        username: "{{ satellite_username }}"
        password: "{{ satellite_password }}"
        server_url: "{{ satellite_server_url }}"
        product: "{{ item.name }}"
        organization: "{{ satellite_organization }}"
      loop: "{{ satellite_products | flatten(levels=1) }}"
      tags:
        - never
        - sync

    - name: Configure Content-Views
      ansible.builtin.import_role:
        name: redhat.satellite.content_views

    - name: Publish Content-Views
      ansible.builtin.import_role:
        name: redhat.satellite.content_view_publish
      tags:
        - never
        - publish

    - name: "Ensure all Composite-Content-Views promoted to Development Lifecycle Environment Stage"
      redhat.satellite.content_view_version:
        username: "{{ satellite_username }}"
        password: "{{ satellite_password }}"
        server_url: "{{ satellite_server_url }}"
        content_view: "{{ item.name }}"
        organization: "{{ satellite_organization }}"
        lifecycle_environments:
          - Development
      # Only promote Composite Content-Views starting with 'CCV-'
      loop: "{{ satellite_content_views | selectattr('name', 'match', '^CCV-.+') }}"


    - name: Housekeeping of Content-Views
      ansible.builtin.import_role:
        name: redhat.satellite.content_view_version_cleanup
      vars:
        satellite_content_view_version_cleanup_keep: 1

    - name: Apply additional Satellite Settings
      ansible.builtin.import_role:
        name: redhat.satellite.settings

    - name: Configure Satellite Activation-Keys
      ansible.builtin.import_role:
        name: redhat.satellite.activation_keys
