---
- name: 'Install Red Hat Satellite'
  hosts: 'all'
  gather_facts: true  # required for the role redhat.satellite_operations.installer
  become: true  # required for the role redhat.satellite_operations.installer
  roles:
    - name: 'redhat.satellite_operations.installer'

  pre_tasks:
    - name: 'Handle certificate deployment'
      become: true
      when: >
        sat_deploy_certificates is defined
        and sat_deploy_certificates
      block:

        - name: 'Ensure certificate destination directory is present: {{ sat_cert_dest_path }}'
          ansible.builtin.file:
            path: '{{ sat_cert_dest_path }}'
            state: 'directory'
            owner: '{{ sat_cert_dest_path_owner }}'
            group: '{{ sat_cert_dest_path_group }}'
            mode: '{{ sat_cert_dest_path_mode }}'

        - name: 'Deploy Certificates to the Satellite'
          ansible.builtin.copy:
            src: '{{ _t_cert }}'
            dest: '{{ sat_cert_dest_path }}/{{ _t_cert | basename }}'
            owner: '{{ sat_certs_owner }}'
            group: '{{ sat_certs_group }}'
            mode: '{{ sat_certs_mode }}'
          loop: '{{ sat_certs }}'
          loop_control:
            loop_var: '_t_cert'

    - name: 'Configure firewalld'
      ansible.builtin.include_role:
        name: 'redhat.rhel_system_roles.firewall'

    - name: 'Verify {{ sat_package_name }} is installed'
      ansible.builtin.dnf:
        name: '{{ sat_package_name }}'
        state: 'present'
